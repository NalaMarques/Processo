<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Acompanhamento Processual</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
    .container { max-width: 1200px; margin: auto; background: #fff; padding: 20px 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    h1, h2 { color: #0056b3; text-align: center; }
    #toolbar { display:flex; gap:10px; justify-content:center; margin:10px 0 20px; flex-wrap: wrap; }
    #toolbar button { background:#0b7; color:#fff; border:0; border-radius:6px; padding:10px 14px; cursor:pointer; }
    #toolbar button.secondary { background:#666; }
    #toolbar button.warn { background:#d33; }
    #form-processo { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
    .form-group { display: flex; flex-direction: column; }
    label { margin-bottom: 5px; font-weight: bold; }
    input[type="date"], input[type="text"], select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
    button[type="submit"] { background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; grid-column: 1 / -1; }
    button[type="submit"]:hover { background-color: #0056b3; }
    #tabela-processos { width: 100%; border-collapse: collapse; margin-top: 20px; }
    #tabela-processos th, #tabela-processos td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    #tabela-processos th { background-color: #f2f2f2; color: #555; text-transform: uppercase; }
    #tabela-processos tr:nth-child(even) { background-color: #f9f9f9; }
    .acoes button { padding: 6px 10px; font-size: 14px; margin-right: 5px; border:0; border-radius:4px; color:#fff; cursor:pointer; }
    .edit-btn { background-color: #ffc107; color:#000; }
    .delete-btn { background-color: #dc3545; }
    .status { margin-top: 10px; font-size: 14px; text-align:center; }
    .muted { color:#666; font-size:12px; text-align:center; }

    /* Barra de busca */
    #busca-wrap { display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-top:14px; }
    #busca-processo { flex:1 1 420px; padding:10px; border:1px solid #ccc; border-radius:4px; font-size:16px; }
    #busca-clear { background:#666; color:#fff; border:0; border-radius:6px; padding:10px 14px; cursor:pointer; }
    #contador-registros { font-size:12px; color:#555; }
    #contador-registros button { margin-left:6px; padding:4px 8px; border:1px solid #ccc; background:#fff; border-radius:4px; cursor:pointer; }
    #contador-registros button:disabled { opacity:.5; cursor:not-allowed; }
  </style>
</head>
<body>
<div class="container">
  <h1>Acompanhamento Processual</h1>

  <div id="toolbar">
    <button id="btn-testar">Testar conexão</button>
    <button id="btn-sincronizar" class="secondary">Sincronizar com planilha</button>
    <button id="btn-limpar-cache" class="warn">Limpar cache local</button>
  </div>

  <form id="form-processo">
    <!-- IDs internos -->
    <input type="hidden" id="processo-id">   <!-- ID da planilha -->
    <input type="hidden" id="local-index">    <!-- índice no array local -->

    <div class="form-group">
      <label for="data-recebimento">Data de Recebimento:</label>
      <input type="date" id="data-recebimento" required>
    </div>

    <div class="form-group">
      <label for="numero-processo">Número do Processo:</label>
      <input type="text" id="numero-processo" placeholder="Ex: 23112.001234/2025-01" required>
    </div>

    <div class="form-group">
      <label for="tipo-documento">Tipo de Documento:</label>
      <input type="text" id="tipo-documento" placeholder="Ex: Despacho, Ofício" required>
    </div>

    <div class="form-group">
      <label for="unidade-sei">Unidade SEI:</label>
      <input type="text" id="unidade-sei" placeholder="Ex: GEDIRFO / DIRFO-URJ" required>
    </div>

    <div class="form-group">
      <label for="solicitacao">Solicitação:</label>
      <input type="text" id="solicitacao" placeholder="Ex: Análise de processo de férias" required>
    </div>

    <div class="form-group">
      <label for="situacao">Situação:</label>
      <select id="situacao" required>
        <option value="Pendente">Pendente</option>
        <option value="Em Análise">Em Análise</option>
        <option value="Feito">Feito</option>
      </select>
    </div>

    <div class="form-group">
      <label for="data-conclusao">Data de Conclusão:</label>
      <input type="date" id="data-conclusao">
    </div>

    <div class="form-group">
      <label for="correcao">Correção:</label>
      <select id="correcao" required>
        <option value="Pendente">Pendente</option>
        <option value="Feito">Feito</option>
      </select>
    </div>

    <button type="submit" id="btn-submit">Adicionar Processo</button>
    <div class="status" id="status"></div>
  </form>

  <!-- Barra de busca -->
  <div id="busca-wrap">
    <input id="busca-processo" type="text" placeholder="Buscar por nº do processo, unidade, solicitação, tipo, situação, correção ou data...">
    <button id="busca-clear" type="button">Limpar busca</button>
    <span id="contador-registros"></span>
  </div>

  <h2>Processos Cadastrados</h2>
  <table id="tabela-processos">
    <thead>
      <tr>
        <th>Data Recebimento</th>
        <th>Nº Processo</th>
        <th>Tipo</th>
        <th>Unidade SEI</th>
        <th>Solicitação</th>
        <th>Situação</th>
        <th>Data Conclusão</th>
        <th>Correção</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- ÚNICA alteração feita nesta linha -->
  <p class="muted">* Os dados ficam salvos na planilha (via Web App) e em cache local (funciona offline e sincroniza quando a conexão volta). (Sistema Desenvolvido por Alan Marques - P0102478)</p>
</div>

<script>
(function () {
  // ====== SUA URL /exec ======
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz73ElJnugw7BNTtk2fPQVughJZ5itDgWIG6IqGk0wIGjbiXiMAOQSPU65qVueBALJzSA/exec";

  // ====== ESTADO ======
  const form = document.getElementById('form-processo');
  const tabelaCorpo = document.querySelector('#tabela-processos tbody');
  const statusEl = document.getElementById('status');
  const btnTestar = document.getElementById('btn-testar');
  const btnSync = document.getElementById('btn-sincronizar');
  const btnClear = document.getElementById('btn-limpar-cache');

  const buscaInput = document.getElementById('busca-processo');
  const buscaClear = document.getElementById('busca-clear');
  const contadorReg = document.getElementById('contador-registros');

  let processos = JSON.parse(localStorage.getItem('processos')) || [];

  // ====== PAGINAÇÃO ======
  const TAM_PAGINA = 10;         // <= 10 por página
  let paginaAtual = 1;

  // ====== HELPERS ======
  function setStatus(msg, ok=true) {
    statusEl.textContent = msg;
    statusEl.style.color = ok ? '#0a7' : '#d33';
  }

  function salvarCache() {
    localStorage.setItem('processos', JSON.stringify(processos));
  }

  // normaliza texto p/ comparação
  function norm(v) {
    return (v ?? '').toString().toLowerCase().trim();
  }

  // aplica o filtro atual sobre a lista completa
  function filtrarLista() {
    const q = norm(buscaInput.value);
    if (!q) return processos.slice();
    return processos.filter(p => {
      return [
        p.numeroProcesso,
        p.unidadeSEI,
        p.solicitacao,
        p.tipoDocumento,
        p.situacao,
        p.correcao,
        p.dataRecebimento,
        p.dataConclusao
      ].some(campo => norm(campo).includes(q));
    });
  }

  // ====== PAGINAÇÃO: utilitário
  function clampaPagina(p, totalPaginas) {
    if (totalPaginas < 1) return 1;
    return Math.max(1, Math.min(p, totalPaginas));
  }

  // atualiza contador de registros exibidos + controles
  function atualizarContador(totalExibidos, total, inicioIdx, fimIdx, totalPaginas) {
    if (!total) {
      contadorReg.textContent = 'Nenhum registro';
      return;
    }
    const desabilitaPrev = paginaAtual <= 1 ? 'disabled' : '';
    const desabilitaNext = paginaAtual >= totalPaginas ? 'disabled' : '';
    contadorReg.innerHTML = `
      Mostrando ${TAM_PAGINA} por página — pág. ${paginaAtual}/${totalPaginas}
      — ${inicioIdx + 1}–${fimIdx} de ${total} registro(s)
      <button data-page="prev" ${desabilitaPrev}>Anterior</button>
      <button data-page="next" ${desabilitaNext}>Próxima</button>
    `;
  }

  // renderização da tabela (aceita lista completa; pagina aqui)
  function renderizarTabela(listaCompleta) {
    const dados = Array.isArray(listaCompleta) ? listaCompleta : processos;
    const total = dados.length;
    const totalPaginas = Math.max(1, Math.ceil(total / TAM_PAGINA));
    paginaAtual = clampaPagina(paginaAtual, totalPaginas);

    const inicio = (paginaAtual - 1) * TAM_PAGINA;
    const fim = Math.min(inicio + TAM_PAGINA, total);
    const pagina = dados.slice(inicio, fim);

    tabelaCorpo.innerHTML = '';
    pagina.forEach((p, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.dataRecebimento || ''}</td>
        <td>${p.numeroProcesso || ''}</td>
        <td>${p.tipoDocumento || ''}</td>
        <td>${p.unidadeSEI || ''}</td>
        <td>${p.solicitacao || ''}</td>
        <td>${p.situacao || ''}</td>
        <td>${p.dataConclusao || ''}</td>
        <td>${p.correcao || ''}</td>
        <td class="acoes">
          <button class="edit-btn" data-index="${index}">Editar</button>
          <button class="delete-btn" data-index="${index}">Excluir</button>
        </td>
      `;
      tabelaCorpo.appendChild(tr);
    });

    atualizarContador(pagina.length, total, inicio, fim, totalPaginas);
  }

  async function apiRequest(method, action, payload) {
    try {
      if (method === 'GET') {
        const resp = await fetch(`${WEB_APP_URL}?action=${encodeURIComponent(action)}`, { method: 'GET' });
        return await resp.json();
      } else {
        // text/plain evita preflight (OPTIONS) no Apps Script
        const resp = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action, payload })
        });
        return await resp.json();
      }
    } catch (e) {
      console.error(e);
      throw new Error('Falha ao comunicar com a planilha. Verifique a URL /exec e o deploy.');
    }
  }

  async function carregarDoServidor() {
    const res = await apiRequest('GET', 'list');
    if (!res || !res.success) throw new Error(res && res.message ? res.message : 'Retorno inválido.');
    processos = Array.isArray(res.data) ? res.data : [];
    salvarCache();
    paginaAtual = 1; // PAGINAÇÃO: volta para a 1ª página ao sincronizar
    renderizarTabela(filtrarLista());
  }

  async function criarNoServidor(processo) {
    const res = await apiRequest('POST', 'create', processo);
    if (!res.success) throw new Error(res.message || 'Erro ao criar.');
    if (res.id) processo.id = res.id;
    return processo;
  }

  async function atualizarNoServidor(processo) {
    if (!processo.id) throw new Error('Registro sem ID. Não é possível atualizar.');
    const res = await apiRequest('POST', 'update', processo);
    if (!res.success) throw new Error(res.message || 'Erro ao atualizar.');
    return true;
  }

  async function excluirNoServidor(id) {
    const res = await apiRequest('POST', 'delete', { id });
    if (!res.success) throw new Error(res.message || 'Erro ao excluir.');
    return true;
  }

  // ====== SUBMIT ======
  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    const processo = {
      id: document.getElementById('processo-id').value || null,
      dataRecebimento: document.getElementById('data-recebimento').value,
      numeroProcesso: document.getElementById('numero-processo').value,
      tipoDocumento: document.getElementById('tipo-documento').value,
      unidadeSEI: document.getElementById('unidade-sei').value,
      solicitacao: document.getElementById('solicitacao').value,
      situacao: document.getElementById('situacao').value,
      dataConclusao: document.getElementById('data-conclusao').value,
      correcao: document.getElementById('correcao').value,
    };

    const localIndex = document.getElementById('local-index').value;

    try {
      if (processo.id) {
        setStatus('Atualizando na planilha...', true);
        await atualizarNoServidor(processo);
        if (localIndex !== '') processos[Number(localIndex)] = processo;
        salvarCache();
        renderizarTabela(filtrarLista());
        setStatus('Atualizado com sucesso.', true);
        document.getElementById('btn-submit').textContent = 'Adicionar Processo';
      } else {
        setStatus('Salvando na planilha...', true);
        const created = await criarNoServidor(processo);
        processos.push(created);
        salvarCache();
        renderizarTabela(filtrarLista());
        setStatus('Criado com sucesso.', true);
      }
      form.reset();
      document.getElementById('processo-id').value = '';
      document.getElementById('local-index').value = '';
    } catch (e) {
      setStatus(e.message || 'Erro ao salvar.', false);
    }
  });

  // ====== AÇÕES DA TABELA ======
  tabelaCorpo.addEventListener('click', async (event) => {
    const btn = event.target;

    if (btn.classList.contains('edit-btn')) {
      const linha = btn.closest('tr');
      const numProc = linha?.children?.[1]?.textContent ?? '';
      const p = processos.find(x => (x.numeroProcesso || '') === numProc);
      if (!p) return;

      const realIndex = processos.indexOf(p);
      document.getElementById('processo-id').value = p.id || '';
      document.getElementById('local-index').value = realIndex;
      document.getElementById('data-recebimento').value = p.dataRecebimento || '';
      document.getElementById('numero-processo').value = p.numeroProcesso || '';
      document.getElementById('tipo-documento').value = p.tipoDocumento || '';
      document.getElementById('unidade-sei').value = p.unidadeSEI || '';
      document.getElementById('solicitacao').value = p.solicitacao || '';
      document.getElementById('situacao').value = p.situacao || 'Pendente';
      document.getElementById('data-conclusao').value = p.dataConclusao || '';
      document.getElementById('correcao').value = p.correcao || 'Pendente';

      document.getElementById('btn-submit').textContent = 'Salvar Alterações';
      setStatus('Editando registro...', true);
    }

    if (btn.classList.contains('delete-btn')) {
      const linha = btn.closest('tr');
      const numProc = linha?.children?.[1]?.textContent ?? '';
      const p = processos.find(x => (x.numeroProcesso || '') === numProc);
      if (!p) return;
      if (!confirm('Confirma a exclusão deste processo?')) return;

      try {
        if (!p.id) throw new Error('Registro sem ID. Não é possível excluir na planilha.');
        setStatus('Excluindo na planilha...', true);
        await excluirNoServidor(p.id);
        const realIndex = processos.indexOf(p);
        if (realIndex >= 0) processos.splice(realIndex, 1);
        salvarCache();
        renderizarTabela(filtrarLista());
        setStatus('Excluído com sucesso.', true);
      } catch (e) {
        setStatus(e.message || 'Erro ao excluir.', false);
      }
    }
  });

  // ====== BOTÕES EXTRAS ======
  btnTestar.addEventListener('click', async () => {
    try {
      setStatus('Testando conexão...', true);
      const res = await apiRequest('GET', 'list');
      setStatus(`Conexão OK. Registros na planilha: ${Array.isArray(res.data) ? res.data.length : 0}`, true);
    } catch (e) {
      setStatus(e.message, false);
    }
  });

  btnSync.addEventListener('click', async () => {
    try {
      setStatus('Sincronizando com a planilha...', true);
      await carregarDoServidor();
      setStatus('Sincronizado.', true);
    } catch (e) {
      setStatus('Não foi possível sincronizar: ' + e.message, false);
    }
  });

  btnClear.addEventListener('click', () => {
    if (!confirm('Limpar cache local? Isso NÃO apaga a planilha.')) return;
    processos = [];
    salvarCache();
    renderizarTabela([]);
    setStatus('Cache local limpo. Você pode sincronizar novamente para puxar da planilha.', true);
  });

  // ====== BUSCA ======
  let buscaTimer = null;
  function onBuscaChange() {
    clearTimeout(buscaTimer);
    buscaTimer = setTimeout(() => {
      paginaAtual = 1; // PAGINAÇÃO: ao buscar, volta para 1ª página
      const lista = filtrarLista();
      renderizarTabela(lista);
    }, 150);
  }
  buscaInput.addEventListener('input', onBuscaChange);
  buscaClear.addEventListener('click', () => {
    buscaInput.value = '';
    paginaAtual = 1; // PAGINAÇÃO
    const lista = filtrarLista();
    renderizarTabela(lista);
    buscaInput.focus();
  });

  // ====== PAGINAÇÃO: navegação por botões no contador ======
  contadorReg.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-page]');
    if (!btn) return;
    const acao = btn.getAttribute('data-page');
    const lista = filtrarLista();
    const totalPaginas = Math.max(1, Math.ceil(lista.length / TAM_PAGINA));
    if (acao === 'prev') paginaAtual = clampaPagina(paginaAtual - 1, totalPaginas);
    if (acao === 'next') paginaAtual = clampaPagina(paginaAtual + 1, totalPaginas);
    renderizarTabela(lista);
  });

  // ====== INICIALIZAÇÃO ======
  (async function init() {
    renderizarTabela(filtrarLista());
    try {
      await carregarDoServidor();
      setStatus('Dados carregados da planilha.', true);
    } catch (e) {
      setStatus('Sem sincronização agora; usando cache local. ' + e.message, false);
      console.warn(e);
    }
  })();
})();
</script>
</body>
</html>
